{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styleTrade.css') }}">
<style>
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-30px); }
    to { opacity: 1; transform: translateX(0); }
}

.page-header {
    animation: fadeInUp 0.6s ease-out;
}

.trade-form {
    animation: slideInLeft 0.8s ease-out;
}

.form-section {
    animation: fadeInUp 0.8s ease-out;
    animation-fill-mode: both;
}

.form-section:nth-child(1) { animation-delay: 0.1s; }
.form-section:nth-child(2) { animation-delay: 0.2s; }
.form-section:nth-child(3) { animation-delay: 0.3s; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="bi bi-plus-circle me-3"></i>
        Registrar Trade
    </h1>
    <p class="page-subtitle">Registra tus operaciones de trading para mantener un control detallado de tu rendimiento</p>
</div>

<div class="trade-container">
    <div class="action-bar">
        <button class="btn btn-success btn-lg" onclick="openNotebookModal()">
            <i class="bi bi-journal-plus me-2"></i>
            Crear Cuaderno
        </button>
    </div>

    <!-- Modal para crear cuaderno -->
    <div id="notebookModal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="closeNotebookModal()"></div>
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-journal-plus me-2"></i>
                        Crear Cuaderno
                    </h5>
                    <button type="button" class="btn-close" onclick="closeNotebookModal()" aria-label="Close">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="notebookForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="form-group">
                            <label for="name" class="form-label">
                                <i class="bi bi-tag me-2"></i>
                                Nombre del Cuaderno
                            </label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="initial_balance" class="form-label">
                                <i class="bi bi-currency-dollar me-2"></i>
                                Monto Inicial
                            </label>
                            <input type="number" class="form-control" id="initial_balance" name="initial_balance" required>
                        </div>
                        <div class="form-group">
                            <label for="account_type" class="form-label">
                                <i class="bi bi-gear me-2"></i>
                                Tipo de Cuenta
                            </label>
                            <select class="form-control" id="account_type" name="account_type" required>
                                <option value="Demo">Demo</option>
                                <option value="Real">Real</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNotebookModal()">
                        <i class="bi bi-x-circle me-2"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="createNotebook()">
                        <i class="bi bi-check-circle me-2"></i>
                        Crear Cuaderno
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="form-container">
        <form action="{{ url_for('register_trade') }}" method="POST" enctype="multipart/form-data" class="trade-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="form-section">
                <h3 class="form-title">
                    <i class="bi bi-info-circle me-2"></i>
                    Información del Trade
                </h3>
                
                <div class="form-group">
                    <label for="notebook_id" class="form-label">
                        <i class="bi bi-journal me-2"></i>
                        Selecciona Cuaderno
                    </label>
                    <select id="notebook_id" name="notebook_id" class="form-control" required>
                        <option value="">Selecciona un cuaderno</option>
                        {% for notebook in notebooks %}
                            <option value="{{ notebook.id }}">{{ notebook.name }} - {{ notebook.account_type }} - ${{ notebook.initial_balance }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="asset" class="form-label">
                            <i class="bi bi-graph-up me-2"></i>
                            Activo Operado
                        </label>
                        <select id="asset" name="asset" class="form-control" required>
                            <option value="BOOM300">BOOM300</option>
                            <option value="BOOM500">BOOM500</option>
                            <option value="BOOM600">BOOM600</option>
                            <option value="BOOM900">BOOM900</option>
                            <option value="BOOM1000">BOOM1000</option>
                            <option value="CRASH300">CRASH300</option>
                            <option value="CRASH500">CRASH500</option>
                            <option value="CRASH600">CRASH600</option>
                            <option value="CRASH900">CRASH900</option>
                            <option value="CRASH1000">CRASH1000</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lot_size" class="form-label">
                            <i class="bi bi-calculator me-2"></i>
                            Lotaje Operado
                        </label>
                        <input type="number" id="lot_size" name="lot_size" step="0.1" class="form-control" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="entry_point" class="form-label">
                            <i class="bi bi-arrow-up-right me-2"></i>
                            Punto de Entrada
                        </label>
                        <input type="number" class="form-control" id="entry_point" name="entry_point" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="stop_loss" class="form-label">
                            <i class="bi bi-shield-exclamation me-2"></i>
                            Stop Loss
                        </label>
                        <input type="number" class="form-control" id="stop_loss" name="stop_loss" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="take_profit" class="form-label">
                        <i class="bi bi-trophy me-2"></i>
                        Take Profit
                    </label>
                    <input type="number" class="form-control" id="take_profit" name="take_profit" step="0.01">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="result" class="form-label">
                            <i class="bi bi-check-circle me-2"></i>
                            Resultado de la Operación
                        </label>
                        <select id="result" name="result" class="form-control" required>
                            <option value="Ganadora">Ganadora</option>
                            <option value="Perdedora">Perdedora</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="trade_date" class="form-label">
                            <i class="bi bi-calendar me-2"></i>
                            Fecha de la Operación
                        </label>
                        <input type="date" class="form-control" id="trade_date" name="trade_date" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="emotion" class="form-label">
                            <i class="bi bi-heart me-2"></i>
                            Emoción al Operar
                        </label>
                        <select id="emotion" name="emotion" class="form-control" required>
                            <option value="Confianza">Confianza</option>
                            <option value="Ansiedad">Ansiedad</option>
                            <option value="Optimismo">Optimismo</option>
                            <option value="Miedo">Miedo</option>
                            <option value="Euforia">Euforia</option>
                            <option value="Irritación">Irritación</option>
                            <option value="Calma">Calma</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="activation_routine" class="form-label">
                            <i class="bi bi-check-square me-2"></i>
                            ¿Realizaste tu rutina de activación?
                        </label>
                        <select id="activation_routine" name="activation_routine" class="form-control" required>
                            <option value="yes">Sí</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="entry_image" class="form-label">
                        <i class="bi bi-image me-2"></i>
                        Imagen de Entrada
                    </label>
                    <input type="file" class="form-control" id="entry_image" name="entry_image" accept="image/*">
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="bi bi-save me-2"></i>
                    Registrar Trade
                </button>
            </div>
        </form>
    </div>
</div>


<script>
    function openNotebookModal() {
        const modal = document.getElementById('notebookModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Animación de entrada
        const modalDialog = modal.querySelector('.modal-dialog');
        modalDialog.style.transform = 'scale(0.9)';
        modalDialog.style.opacity = '0';
        
        setTimeout(() => {
            modalDialog.style.transform = 'scale(1)';
            modalDialog.style.opacity = '1';
        }, 10);
    }

    function closeNotebookModal() {
        const modal = document.getElementById('notebookModal');
        const modalDialog = modal.querySelector('.modal-dialog');
        
        // Animación de salida
        modalDialog.style.transform = 'scale(0.9)';
        modalDialog.style.opacity = '0';
        
        setTimeout(() => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }, 200);
    }

    // Crear cuaderno vía AJAX
    function createNotebook() {
        const form = document.getElementById('notebookForm');
        const formData = new FormData(form);
        
        // Validar campos requeridos
        const name = document.getElementById('name').value.trim();
        const initialBalance = document.getElementById('initial_balance').value;
        const accountType = document.getElementById('account_type').value;
        
        if (!name || !initialBalance || !accountType) {
            alert('Por favor completa todos los campos requeridos');
            return;
        }

        // Mostrar loading en el botón
        const createBtn = document.querySelector('.modal-footer .btn-success');
        const originalText = createBtn.innerHTML;
        createBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Creando...';
        createBtn.disabled = true;

        fetch("{{ url_for('create_notebook') }}", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                // Añadir el nuevo cuaderno al selector sin recargar la página
                const notebookSelect = document.getElementById('notebook_id');
                const option = document.createElement('option');
                option.value = data.id;
                option.textContent = `${data.name} - ${data.account_type} - $${data.initial_balance}`;
                notebookSelect.appendChild(option);
                notebookSelect.value = data.id;  // Selecciona el nuevo cuaderno
                
                // Limpiar el formulario
                form.reset();
                
                // Cerrar modal
                closeNotebookModal();
                
                // Mostrar mensaje de éxito
                alert("Cuaderno creado exitosamente");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al crear el cuaderno. Intenta nuevamente.');
        })
        .finally(() => {
            // Restaurar el botón
            createBtn.innerHTML = originalText;
            createBtn.disabled = false;
        });
    }

    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('notebookModal');
            if (modal.style.display === 'flex') {
                closeNotebookModal();
            }
        }
    });
</script>

{% endblock %}